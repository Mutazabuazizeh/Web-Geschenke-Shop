<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Admin Bereich</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>

<script>
  const user = JSON.parse(localStorage.getItem('user') || 'null');
  if (!user || user.role !== 'admin') {
    window.location.href = 'auth.html';
  }
</script>

<div id="admin-page">
  <h1>Admin Bereich</h1>

  <div style="margin-bottom: 16px;">
    <button @click="logout">Logout</button>
  </div>

  <div v-if="error" style="color:red; margin-bottom: 12px;">
    {{ error }}
  </div>

  <div v-if="loading">Loading...</div>

  <div v-else>
    <h2>Bestellungen</h2>

    <div v-if="orders.length === 0">
      Keine Bestellungen vorhanden.
    </div>

    <table v-else border="1" cellpadding="6" cellspacing="0">
      <thead>
        <tr>
          <th>ID</th>
          <th>Käufername</th>
          <th>Adresse</th>
          <th>Produkte</th>
          <th>Total (€)</th>
          <th>Status</th>
          <th>Created At</th>
        </tr>
      </thead>
      <tbody>
        <tr v-for="o in orders" :key="o.id">
          <td>{{ o.id }}</td>
          <td>{{ o.buyer_name || '-' }}</td>
          <td>{{ o.address || '-' }}</td>
          <td>
            <div v-for="item in o.items" :key="item.id" style="margin-bottom: 4px;">
              {{ item.title }} ({{ item.quantity }}x)
            </div>
          </td>
          <td>{{ Number(o.total).toFixed(2) }}</td>
          <td>{{ o.status }}</td>
          <td>{{ o.created_at }}</td>
        </tr>
      </tbody>
    </table>

    <hr style="margin: 24px 0;">

    <h2>Produkte (Lagerbestand bearbeiten)</h2>

    <div v-if="products.length === 0">
      Keine Produkte vorhanden.
    </div>

    <table v-else border="1" cellpadding="6" cellspacing="0">
      <thead>
        <tr>
          <th>ID</th>
          <th>Title</th>
          <th>Price (€)</th>
          <th>Stock</th>
          <th>Save</th>
        </tr>
      </thead>
      <tbody>
        <tr v-for="p in products" :key="p.id">
          <td>{{ p.id }}</td>
          <td>{{ p.title }}</td>
          <td>{{ Number(p.price).toFixed(2) }}</td>
          <td style="width:140px;">
            <input type="number" min="0" v-model.number="p.stock" style="width: 90px;">
          </td>
          <td style="width:120px;">
            <button @click="saveStock(p)">Speichern</button>
          </td>
        </tr>
      </tbody>
    </table>

  </div>
</div>

<script>
const { createApp } = Vue;

createApp({
  data() {
    return {
      loading: true,
      error: '',
      orders: [],
      products: []
    };
  },

  methods: {
    logout() {
      localStorage.removeItem('user');
      window.location.href = 'auth.html';
    },

    async loadAdminData() {
      this.loading = true;
      this.error = '';

      const user = JSON.parse(localStorage.getItem('user') || 'null');

      try {
        const res = await fetch('php/admin.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId: user?.id, role: user?.role })
        });

        const text = await res.text();
        console.log('admin.php raw response:', text);

        let data;
        try {
          data = JSON.parse(text);
        } catch {
          throw new Error('Response is not valid JSON (check PHP error output).');
        }

        console.log('admin.php json:', data);

        if (!res.ok) {
          throw new Error(data?.error || 'Admin request failed');
        }

        this.orders = data.orders || [];
        this.products = data.products || [];
      } catch (e) {
        console.error(e);
        this.error = e.message || 'Server error';
      } finally {
        this.loading = false;
      }
    },

    async saveStock(product) {
      this.error = '';

      const user = JSON.parse(localStorage.getItem('user') || 'null');
      const stock = Number(product.stock);

      if (Number.isNaN(stock) || stock < 0) {
        this.error = 'Stock value invalid';
        return;
      }

      try {
        const res = await fetch('php/update-stock.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            userId: user?.id,
            role: user?.role,
            productId: product.id,
            stock
          })
        });

        const text = await res.text();
        console.log('update-stock.php raw response:', text);

        let data;
        try {
          data = JSON.parse(text);
        } catch {
          throw new Error('Response is not valid JSON (check PHP error output).');
        }

        if (!res.ok || !data.success) {
          throw new Error(data?.error || 'Failed to update stock');
        }

        await this.loadAdminData();
      } catch (e) {
        console.error(e);
        this.error = e.message || 'Server error';
      }
    }
  },

  mounted() {
    this.loadAdminData();
  }
}).mount('#admin-page');
</script>

</body>
</html>
